name: BE V2 수동 배포/롤백
run-name: BE V2 Manual • ${{ inputs.image_tag || 'latest' }}

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: "배포할 이미지 태그 (예: sha-abc1234)"
        required: true

permissions:
  id-token: write

jobs:
  deploy:
    runs-on: ubuntu-24.04-arm
    environment: develop
    env:
      AWS_REGION: ap-northeast-2
      IMAGE_TAG: ${{ inputs.image_tag }}
      COMPOSE_DIR: /home/ubuntu/backend

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Sync config to S3
        run: aws s3 sync docker/ s3://moyeobab-dev-config/backend/ --delete

      - name: Deploy via SSM Send Command
        id: ssm-deploy
        run: |
          COMMAND_ID=$(aws ssm send-command \
            --targets "Key=tag:Service,Values=backend" "Key=tag:Environment,Values=dev" \
            --document-name "AWS-RunShellScript" \
            --comment "Manual deploy backend ${{ env.IMAGE_TAG }}" \
            --timeout-seconds 300 \
            --max-concurrency "1" \
            --max-errors "0" \
            --parameters commands='[
              "set -e",
              "REGION='"${{ env.AWS_REGION }}"'",
              "IMAGE_TAG='"${{ env.IMAGE_TAG }}"'",
              "COMPOSE_DIR='"${{ env.COMPOSE_DIR }}"'",
              "",
              "# S3에서 배포 설정 파일 동기화",
              "mkdir -p ${COMPOSE_DIR}",
              "aws s3 sync s3://moyeobab-dev-config/backend/ ${COMPOSE_DIR}/ --exclude '.env' --region ${REGION}",
              "",
              "# ECR login",
              "ECR_REGISTRY=$(aws sts get-caller-identity --query Account --output text).dkr.ecr.${REGION}.amazonaws.com",
              "aws ecr get-login-password --region ${REGION} | docker login --username AWS --password-stdin ${ECR_REGISTRY}",
              "",
              "# Parameter Store → .env",
              "> ${COMPOSE_DIR}/.env",
              "for param in DB_URL DB_USERNAME DB_PASSWORD REDIS_HOST REDIS_PORT REDIS_PASSWORD JWT_SECRET JWT_ISSUER JWT_ACCESS_TOKEN_EXPIRE_MINUTES JWT_COOKIE_NAME JWT_COOKIE_SAME_SITE JWT_COOKIE_SECURE JWT_REFRESH_COOKIE_NAME JWT_REFRESH_TOKEN_EXPIRE_DAYS KAKAO_CLIENT_ID KAKAO_CLIENT_SECRET KAKAO_ADMIN_KEY KAKAO_REDIRECT_URI KAKAO_FRONTEND_REDIRECT_URL KAKAO_UNLINK_URL CSRF_COOKIE_DOMAIN; do",
              "  val=$(aws ssm get-parameter --name /moyeobab/spring/dev/${param} --with-decryption --query \"Parameter.Value\" --output text --region ${REGION})",
              "  echo \"${param}=${val}\" >> ${COMPOSE_DIR}/.env",
              "done",
              "echo \"ECR_REGISTRY=${ECR_REGISTRY}\" >> ${COMPOSE_DIR}/.env",
              "echo \"IMAGE_TAG=${IMAGE_TAG}\" >> ${COMPOSE_DIR}/.env",
              "",
              "# Deploy",
              "cd ${COMPOSE_DIR} && docker compose pull && docker compose up -d",
              "",
              "# Health check",
              "sleep 15",
              "curl -sf --retry 10 --retry-delay 5 http://localhost:8080/actuator/health",
              "echo \"Health check passed\"",
              "docker image prune -f"
            ]' \
            --query "Command.CommandId" --output text)

          echo "command_id=$COMMAND_ID" >> "$GITHUB_OUTPUT"
          echo "Command ID: $COMMAND_ID"

      - name: Wait for deployment result
        id: wait-result
        run: |
          COMMAND_ID="${{ steps.ssm-deploy.outputs.command_id }}"

          sleep 5
          INSTANCE_IDS=$(aws ssm list-command-invocations \
            --command-id "$COMMAND_ID" \
            --query "CommandInvocations[*].InstanceId" \
            --output text)

          ALL_SUCCESS=true
          for INSTANCE_ID in $INSTANCE_IDS; do
            echo "Waiting for $INSTANCE_ID..."
            for i in $(seq 1 60); do
              STATUS=$(aws ssm get-command-invocation \
                --command-id "$COMMAND_ID" \
                --instance-id "$INSTANCE_ID" \
                --query "Status" --output text 2>/dev/null || echo "Pending")

              if [ "$STATUS" = "Success" ]; then
                echo "$INSTANCE_ID: Success"
                break
              elif [ "$STATUS" = "Failed" ] || [ "$STATUS" = "Cancelled" ] || [ "$STATUS" = "TimedOut" ]; then
                echo "$INSTANCE_ID: $STATUS"
                aws ssm get-command-invocation \
                  --command-id "$COMMAND_ID" \
                  --instance-id "$INSTANCE_ID" \
                  --query "StandardErrorContent" --output text || true
                ALL_SUCCESS=false
                break
              fi
              sleep 5
            done
          done

          if [ "$ALL_SUCCESS" = "true" ]; then
            echo "result=success" >> "$GITHUB_OUTPUT"
          else
            echo "result=failure" >> "$GITHUB_OUTPUT"
            exit 1
          fi

      - name: Notify Discord
        if: always()
        env:
          WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            TITLE="BE V2 수동 배포 성공"
            COLOR=3066993
          else
            TITLE="BE V2 수동 배포 실패"
            COLOR=15158332
          fi

          jq -n \
            --arg title "$TITLE" \
            --arg color "$COLOR" \
            --arg tag "${{ env.IMAGE_TAG }}" \
            --arg url "$RUN_URL" \
            '{
              embeds: [{
                title: $title,
                color: ($color | tonumber),
                fields: [
                  {name: "이미지 태그", value: ("`" + $tag + "`"), inline: true},
                  {name: "상세", value: ("[Actions 로그](" + $url + ")"), inline: false}
                ],
                footer: {text: "BE V2 Manual Deploy"}
              }]
            }' | curl -sf -X POST "$WEBHOOK" -H "Content-Type: application/json" -d @-
