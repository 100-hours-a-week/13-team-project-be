name: BE V2 CI Pipeline

on:
  pull_request:
    branches: [develop]
  push:
    branches: [develop]

permissions:
  contents: read
  checks: write
  pull-requests: write
  id-token: write

concurrency:
  group: be-v2-ci-${{ github.ref }}
  cancel-in-progress: true

env:
  JAVA_VERSION: "21"

jobs:
  ci:
    runs-on: ubuntu-24.04-arm
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: temurin
          cache: gradle

      - name: Grant execute permission
        run: chmod +x gradlew

      - name: Build and Verify (Lint, Test)
        run: ./gradlew build -x bootJar --no-daemon --parallel

      - name: Publish Test Report
        uses: mikepenz/action-junit-report@v4
        if: always()
        with:
          report_paths: '**/build/test-results/test/TEST-*.xml'

      - name: Upload CI Reports
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: be-v2-ci-reports-${{ github.run_number }}
          path: build/reports/
          retention-days: 14

  build-and-push:
    needs: ci
    if: github.event_name == 'push'
    runs-on: ubuntu-24.04-arm
    environment: develop
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ap-northeast-2

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build, tag, and push image to Amazon ECR
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: moyeobab/backend
          IMAGE_TAG: sha-${{ github.sha }}
        run: |
          if aws ecr describe-images --repository-name $ECR_REPOSITORY --image-ids imageTag=$IMAGE_TAG 2>/dev/null; then
            echo "Image $IMAGE_TAG already exists, skipping build"
            exit 0
          fi
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG

      - name: Notify Discord
        if: always()
        env:
          WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
          BRANCH: ${{ github.ref_name }}
          RUN_NUM: ${{ github.run_number }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          IMAGE_TAG: sha-${{ github.sha }}
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            TITLE="BE V2 CI 성공"
            DESC="이미지 빌드 및 ECR push 완료 (\`${IMAGE_TAG}\`)"
            COLOR=3066993
          else
            TITLE="BE V2 CI 실패"
            DESC="빌드에 실패했습니다. 로그를 확인해주세요."
            COLOR=15158332
          fi

          jq -n \
            --arg title "$TITLE" \
            --arg desc "$DESC" \
            --arg color "$COLOR" \
            --arg branch "$BRANCH" \
            --arg run_num "$RUN_NUM" \
            --arg tag "$IMAGE_TAG" \
            --arg url "$RUN_URL" \
            '{
              embeds: [{
                title: $title,
                description: $desc,
                color: ($color | tonumber),
                fields: [
                  {name: "브랜치", value: $branch, inline: true},
                  {name: "빌드", value: ("#" + $run_num), inline: true},
                  {name: "이미지 태그", value: ("`" + $tag + "`"), inline: true},
                  {name: "상세", value: ("[Actions 로그](" + $url + ")"), inline: false}
                ],
                footer: {
                  text: "BE V2 CI",
                  icon_url: "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png"
                }
              }]
            }' | curl -sf -X POST "$WEBHOOK" -H "Content-Type: application/json" -d @-
